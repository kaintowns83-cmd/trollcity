<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TrollCity Stream Test</title>
  <style>
    body { font-family: Arial, sans-serif; background: #111; color: white; padding: 20px; }
    video { width: 320px; height: 240px; background: black; }
    button { margin: 10px; padding: 10px; }
  </style>
</head>
<body>
  <h1>TrollCity Mediasoup Test</h1>
  <div>
    <button id="start">Start Camera</button>
    <button id="produce">Produce</button>
    <button id="consume">Consume</button>
  </div>
  <div>
    <video id="localVideo" autoplay muted></video>
    <video id="remoteVideo" autoplay></video>
  </div>
  <div id="log"></div>

  <script>
    const ws = new WebSocket("ws://10.0.0.102:4000");
    const localVideo = document.getElementById('localVideo');
    const remoteVideo = document.getElementById('remoteVideo');
    const log = document.getElementById('log');

    let peerConnection;
    let localStream;
    let peerId;
    let routerRtpCapabilities;
    let transport;

    function logMessage(msg) {
      log.innerHTML += '<p>' + msg + '</p>';
    }

    ws.onopen = () => logMessage('WebSocket connected');

    ws.onmessage = async (event) => {
      const { type, data } = JSON.parse(event.data);
      logMessage('Received: ' + type);

      switch (type) {
        case 'peer-id':
          peerId = data.peerId;
          break;
        case 'rtp-capabilities':
          routerRtpCapabilities = data;
          break;
        case 'transport-created':
          transport = data;
          break;
        case 'transport-connected':
          // Now can produce/consume
          break;
        case 'produced':
          logMessage('Producing...');
          break;
        case 'consuming':
          // Set up remote video
          const remoteStream = new MediaStream();
          remoteVideo.srcObject = remoteStream;
          // In real implementation, add track to stream
          break;
        case 'new-producer':
          // Auto consume
          ws.send(JSON.stringify({
            type: 'consume',
            data: {
              transportId: transport.id,
              producerId: data.producerId,
              rtpCapabilities: routerRtpCapabilities
            }
          }));
          break;
      }
    };

    document.getElementById('start').onclick = async () => {
      localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      localVideo.srcObject = localStream;
    };

    document.getElementById('produce').onclick = () => {
      if (!transport) {
        ws.send(JSON.stringify({ type: 'get-rtp-capabilities' }));
        ws.send(JSON.stringify({ type: 'create-transport' }));
        return;
      }
      // Produce video
      const videoTrack = localStream.getVideoTracks()[0];
      // In real implementation, create offer, etc.
      logMessage('Producing video...');
    };

    document.getElementById('consume').onclick = () => {
      // Consume logic
      logMessage('Consuming...');
    };
  </script>
</body>
</html>